import os, itertools

Import('*')

SRC_DIR = os.path.join(env['ENV']['JUNK2_HOME'], 'src')

preprocess_dir = 'preprocess'
make_preprocess_dir = env.Command(Dir(preprocess_dir), [], Mkdir('$TARGET'))
preprocessings = []
preprocessing_stats = []
if env['PREPROCESSOR'].lower()=='trimmomatic':
    preps = SConscript(os.path.join(preprocess_dir, 'junk2_trimmomatic'),
                       src_dir = SRC_DIR, 
                       variant_dir = preprocess_dir, duplicate = 0, 
                       exports = 'env raw_reads')
    preprocessings.append(preps)
    ## COMPUTE STATISTICS ON PREPROCESSED READS
    for f in itertools.chain(*preprocessings):
        readset = File(f).path
        if not os.path.isabs(readset):
            readset = '#'+readset
        preprocessing_stats.append(SConscript(os.path.join(preprocess_dir, 'junk2_read_statistics'), 
                                              src_dir = SRC_DIR, 
                                              variant_dir = preprocess_dir, duplicate = 0, 
                                              exports = 'env readset')
                                  )

else:
    ## in case of no preprocessor specified or choice not available, just return the raw reads
    for f in raw_reads:
        preprocessings.append(File(f))

## flaten reuslts
#preprocessed_files = [File(f) for f in itertools.chain(*preprocessings)]
preprocessed_files = preprocessings
Return('preprocessed_files')
